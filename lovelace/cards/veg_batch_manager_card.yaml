# =============================================================================
# VEG BATCH MANAGER CARD
# =============================================================================
# Easy interface to add and manage veg batches
#
# REQUIRED: Add these helpers to your configuration.yaml:
#
# input_text:
#   veg_batch_name:
#     name: Batch Name
#     max: 50
#   veg_batch_strain:
#     name: Strain
#     max: 50
#
# input_datetime:
#   veg_batch_start_date:
#     name: Start Date
#     has_date: true
#     has_time: false
#
# input_number:
#   veg_batch_plant_count:
#     name: Plant Count
#     min: 1
#     max: 500
#     step: 1
#     initial: 24
#     mode: box
#
# input_select:
#   veg_batch_stage:
#     name: Stage
#     options:
#       - Clone
#       - Pre-Veg
#       - Early Veg
#       - Late Veg
#       - Mother
#   veg_batch_destination:
#     name: Destination
#     options:
#       - f1
#       - f2
#       - f3
#       - none
#
# =============================================================================

type: vertical-stack
cards:
  - type: custom:mushroom-title-card
    title: "ðŸŒ± Veg Batch Manager"
    subtitle: "Track clones, veg plants, and mothers"

  # Current batches overview
  - type: entities
    title: "ðŸ“Š Current Status"
    entities:
      - entity: sensor.veg_room_status
        name: "Room Status"
      - entity: sensor.veg_room_active_batches
        name: "Active Batches"

  # Batches by stage
  - type: markdown
    content: >-
      ### ðŸ“¦ Batches by Stage
      
      {% set batches = state_attr('sensor.veg_room_status', 'batches_by_stage') %}
      {% if batches and batches | length > 0 %}
      | Stage | Batches | Plants | Names |
      |-------|---------|--------|-------|
      {% for stage, data in batches.items() %}
      | {{ stage }} | {{ data.count }} | {{ data.plants }} | {{ data.batches | join(', ') }} |
      {% endfor %}
      {% else %}
      No active batches. Add one below!
      {% endif %}

  # Add new batch section
  - type: custom:mushroom-title-card
    title: ""
    subtitle: "âž• Add New Batch"

  - type: horizontal-stack
    cards:
      - type: entity
        entity: input_text.veg_batch_name
        name: "Name"
      - type: entity
        entity: input_text.veg_batch_strain
        name: "Strain"

  - type: horizontal-stack
    cards:
      - type: entity
        entity: input_datetime.veg_batch_start_date
        name: "Start Date"
      - type: entity
        entity: input_number.veg_batch_plant_count
        name: "Plants"

  - type: horizontal-stack
    cards:
      - type: entity
        entity: input_select.veg_batch_stage
        name: "Stage"
      - type: entity
        entity: input_select.veg_batch_destination
        name: "Destination"

  - type: button
    name: "ðŸŒ± Add Batch"
    icon: mdi:plus-circle
    tap_action:
      action: call-service
      service: grow_room_manager.add_veg_batch
      data:
        room_id: veg
        batch_name: "{{ states('input_text.veg_batch_name') }}"
        start_date: "{{ states('input_datetime.veg_batch_start_date') }}"
        stage: "{{ states('input_select.veg_batch_stage') }}"
        plant_count: "{{ states('input_number.veg_batch_plant_count') | int }}"
        strain: "{{ states('input_text.veg_batch_strain') }}"
        destination_room: "{{ states('input_select.veg_batch_destination') }}"

  # Quick add buttons
  - type: custom:mushroom-title-card
    title: ""
    subtitle: "âš¡ Quick Add"

  - type: horizontal-stack
    cards:
      - type: button
        name: "ðŸŒ± New Clones"
        icon: mdi:sprout
        tap_action:
          action: call-service
          service: grow_room_manager.add_veg_batch
          data:
            room_id: veg
            batch_name: "Clones {{ now().strftime('%b %d') }}"
            start_date: "{{ now().strftime('%Y-%m-%d') }}"
            stage: Clone
            plant_count: 24
            strain: ""
            destination_room: f1
      - type: button
        name: "ðŸ‘‘ New Mother"
        icon: mdi:crown
        tap_action:
          action: call-service
          service: grow_room_manager.add_veg_batch
          data:
            room_id: veg
            batch_name: "Mother {{ now().strftime('%b %d') }}"
            start_date: "{{ now().strftime('%Y-%m-%d') }}"
            stage: Mother
            plant_count: 1
            strain: ""
            destination_room: none

  # Active batch details
  - type: markdown
    content: >-
      ---
      ### ðŸ“‹ Active Batch Details
      
      {% set batches = state_attr('sensor.veg_room_active_batches', 'batches') %}
      {% if batches and batches | length > 0 %}
      {% for b in batches %}
      **{{ b.name }}** ({{ b.stage }})
      - Plants: {{ b.plants }} | Strain: {{ b.strain or 'N/A' }}
      - Started: {{ b.start_date }} | Dest: {{ b.destination or 'TBD' }}
      
      {% endfor %}
      {% else %}
      No active batches
      {% endif %}

  # Stage progression buttons
  - type: custom:mushroom-title-card
    title: ""
    subtitle: "ðŸ“ˆ Stage Progression"

  - type: markdown
    content: |
      Use the **Developer Tools > Services** to update batch stages:
      
      ```yaml
      service: grow_room_manager.update_veg_batch
      data:
        room_id: veg
        batch_id: [batch_id_here]
        stage: Pre-Veg  # or Early Veg, Late Veg
      ```
      
      Or move to flower:
      
      ```yaml
      service: grow_room_manager.move_to_flower
      data:
        room_id: veg
        batch_id: [batch_id_here]
        flower_room_id: f1
      ```
